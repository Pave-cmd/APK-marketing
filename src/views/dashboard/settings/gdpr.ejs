<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h4 mb-1">游 GDPR & Ochrana dat</h2>
          <p class="text-muted mb-0">Spravujte sv치 opr치vn캩n칤 a soukrom칤</p>
        </div>
        <div class="small text-muted">
          <i class="fas fa-shield-alt me-1"></i> GDPR kompatibiln칤
        </div>
      </div>
    </div>
  </div>

  <!-- Consent Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-cookie-bite me-2 text-primary"></i>
            Spr치va souhlas콢 s cookies
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">
            Spravujte, kter칠 cookies a technologie m콢쬰me pou쮂셨at pro vylep코en칤 va코eho z치쬴tku.
          </p>
          
          <div id="consentSettings">
            <!-- Nezbytn칠 cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-cog me-2 text-secondary"></i>
                    Nezbytn칠 cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Tyto cookies jsou nutn칠 pro z치kladn칤 funk캜nost webu a nelze je vypnout.
                  </p>
                  <div class="small text-info">
                    <strong>P콏칤klady:</strong> autentizace, CSRF ochrana, relace
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentNecessary" checked disabled>
                  <label class="form-check-label" for="consentNecessary">
                    <span class="badge bg-success">V쬯y aktivn칤</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Funk캜n칤 cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-tools me-2 text-info"></i>
                    Funk캜n칤 cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Vylep코uj칤 funkcionalitu a umo쮄갓j칤 personalizaci u쬴vatelsk칠ho rozhran칤.
                  </p>
                  <div class="small text-info">
                    <strong>P콏칤klady:</strong> jazykov칠 preference, rozlo쬰n칤 dashboardu
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentFunctional">
                  <label class="form-check-label" for="consentFunctional"></label>
                </div>
              </div>
            </div>

            <!-- Analytick칠 cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-chart-line me-2 text-warning"></i>
                    Analytick칠 cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Pom치haj칤 n치m pochopit, jak pou쮂셨치te web a zlep코ovat na코e slu쬭y.
                  </p>
                  <div class="small text-info">
                    <strong>P콏칤klady:</strong> Google Analytics, n치v코t캩vnost str치nek
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentAnalytics">
                  <label class="form-check-label" for="consentAnalytics"></label>
                </div>
              </div>
            </div>

            <!-- Marketingov칠 cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-bullhorn me-2 text-danger"></i>
                    Marketingov칠 cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Umo쮄갓j칤 personalizovanou reklamu a marketingovou komunikaci.
                  </p>
                  <div class="small text-info">
                    <strong>P콏칤klady:</strong> c칤len치 reklama, sledov치n칤 kampan칤
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentMarketing">
                  <label class="form-check-label" for="consentMarketing"></label>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="small text-muted">
              <i class="fas fa-clock me-1"></i>
              Nastaven칤 se ulo쮂 automaticky
            </div>
            <button type="button" class="btn btn-primary" id="saveConsentBtn">
              <i class="fas fa-save me-2"></i>Ulo쬴t nastaven칤
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Rights -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-download me-2 text-success"></i>
            Export dat
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            St치hn캩te si v코echna va코e data ve strukturovan칠m form치tu podle GDPR 캜l치nku 20.
          </p>
          <ul class="list-unstyled small mb-4">
            <li><i class="fas fa-check text-success me-2"></i>Osobn칤 informace</li>
            <li><i class="fas fa-check text-success me-2"></i>Nastaven칤 a preference</li>
            <li><i class="fas fa-check text-success me-2"></i>P콏ipojen칠 soci치ln칤 s칤t캩</li>
            <li><i class="fas fa-check text-success me-2"></i>Historie souhlas콢</li>
          </ul>
          <button type="button" class="btn btn-success w-100" id="exportDataBtn">
            <i class="fas fa-download me-2"></i>St치hnout moje data
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card h-100 border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-trash-alt me-2"></i>
            Smaz치n칤 칰캜tu
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Trvale sma쬾e v치코 칰캜et a v코echna souvisej칤c칤 data podle GDPR 캜l치nku 17.
          </p>
          <div class="alert alert-warning small mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Pozor:</strong> Tato akce je nevratn치 a v코echna va코e data budou trvale smaz치na.
          </div>
          <button type="button" class="btn btn-danger w-100" id="deleteAccountBtn" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            <i class="fas fa-trash-alt me-2"></i>Smazat 칰캜et
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Processing Information -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle me-2 text-info"></i>
            Informace o zpracov치n칤 dat
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">Va코e pr치va podle GDPR:</h6>
              <ul class="list-unstyled small">
                <li class="mb-2"><i class="fas fa-eye text-primary me-2"></i><strong>Pr치vo na p콏칤stup:</strong> Zobrazit zpracov치van치 data</li>
                <li class="mb-2"><i class="fas fa-edit text-warning me-2"></i><strong>Pr치vo na opravu:</strong> Upravit nespr치vn칠 칰daje</li>
                <li class="mb-2"><i class="fas fa-download text-success me-2"></i><strong>Pr치vo na p콏enositelnost:</strong> Export va코ich dat</li>
                <li class="mb-2"><i class="fas fa-trash text-danger me-2"></i><strong>Pr치vo na v칳maz:</strong> Smaz치n칤 va코ich dat</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Kontakt pro GDPR:</h6>
              <div class="small">
                <p class="mb-1"><strong>Email:</strong> privacy@bekpashop.cz</p>
                <p class="mb-1"><strong>Telefon:</strong> +420 735 791 715</p>
                <p class="mb-1"><strong>Adresa:</strong> Trnava 298, 917 02 Trnava</p>
              </div>
              <div class="mt-3">
                <a href="/legal/privacy" class="btn btn-outline-secondary btn-sm me-2" target="_blank">
                  <i class="fas fa-external-link-alt me-1"></i>Z치sady ochrany soukrom칤
                </a>
                <a href="/legal/cookies" class="btn btn-outline-secondary btn-sm" target="_blank">
                  <i class="fas fa-external-link-alt me-1"></i>Cookie Policy
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteAccountModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Potvrzen칤 smaz치n칤 칰캜tu
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <h6 class="alert-heading">
            <i class="fas fa-warning me-2"></i>
            Pozor! Tato akce je nevratn치
          </h6>
          <p class="mb-0">Smaz치n칤m 칰캜tu trvale ztrat칤te:</p>
          <ul class="mt-2 mb-0">
            <li>V코echny osobn칤 칰daje</li>
            <li>P콏ipojen칠 soci치ln칤 s칤t캩</li>
            <li>Napl치novan칠 p콏칤sp캩vky</li>
            <li>Historii aktivit</li>
            <li>Nastaven칤 a preference</li>
          </ul>
        </div>
        
        <form id="deleteAccountForm">
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Pro potvrzen칤 zadejte sv칠 heslo:</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="Va코e aktu치ln칤 heslo">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
            <label class="form-check-label" for="confirmDeletion">
              Potvrzujem, 쬰 chci trvale smazat sv콢j 칰캜et a v코echna data
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Zru코it
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash-alt me-2"></i>Smazat 칰캜et
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.consent-item {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 0.5rem;
  background: #f8f9fa;
  transition: all 0.2s ease;
}

.consent-item:hover {
  border-color: #3498db;
  background: #ffffff;
}

.form-check-input:checked {
  background-color: #3498db;
  border-color: #3498db;
}

.card {
  transition: all 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.modal-content {
  border: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.alert-danger {
  border-left: 4px solid #dc3545;
}
</style>

<script>
// Funkce pro inicializaci s opakovan칳m pokusem
function initializeGDPR() {
    console.log('[GDPR] Pokus o inicializaci GDPR str치nky');
    
    // Kontrola existence element콢
    const saveConsentBtn = document.getElementById('saveConsentBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    console.log('[GDPR] Elementy nalezeny:', {
        saveConsentBtn: !!saveConsentBtn,
        exportDataBtn: !!exportDataBtn,
        confirmDeleteBtn: !!confirmDeleteBtn
    });
    
    // Pokud elementy nejsou nalezeny, zkusit znovu
    if (!exportDataBtn || !saveConsentBtn) {
        console.log('[GDPR] Elementy nenalezeny, zkou코칤m znovu za 500ms');
        setTimeout(initializeGDPR, 500);
        return;
    }
    
    // Na캜ten칤 aktu치ln칤ho stavu souhlas콢
    loadCurrentConsent();
    
    // Event listenery s kontrolou existence
    if (saveConsentBtn) {
        saveConsentBtn.addEventListener('click', saveConsent);
        console.log('[GDPR] Event listener pro saveConsent p콏id치n');
    }
    
    if (exportDataBtn) {
        exportDataBtn.addEventListener('click', function(event) {
            console.log('[GDPR] Export button clicked!');
            event.preventDefault();
            exportData();
        });
        console.log('[GDPR] Event listener pro exportData p콏id치n');
    }
    
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', deleteAccount);
        console.log('[GDPR] Event listener pro deleteAccount p콏id치n');
    }
    
    // Auto-save p콏i zm캩n캩
    const consentInputs = document.querySelectorAll('#consentSettings input[type="checkbox"]:not([disabled])');
    console.log('[GDPR] Nalezeno', consentInputs.length, 'consent input콢');
    consentInputs.forEach(input => {
        input.addEventListener('change', autoSaveConsent);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[GDPR] DOMContentLoaded event fired');
    // Mal치 prodleva pro zaji코t캩n칤, 쬰 jsou v코echny elementy v DOM
    setTimeout(initializeGDPR, 100);
});

// Tak칠 zkusit inicializaci po na캜ten칤 okna
window.addEventListener('load', function() {
    console.log('[GDPR] Window load event fired');
    setTimeout(initializeGDPR, 100);
});

function loadCurrentConsent() {
    // Pokud existuje CookieConsent, na캜teme aktu치ln칤 stav
    if (window.cookieConsent) {
        const consent = window.cookieConsent.getCurrentConsent();
        if (consent) {
            document.getElementById('consentFunctional').checked = consent.functional || false;
            document.getElementById('consentAnalytics').checked = consent.analytics || false;
            document.getElementById('consentMarketing').checked = consent.marketing || false;
        }
    }
}

async function autoSaveConsent() {
    await saveConsent(false); // false = tich칳 re쬴m bez notifikace
}

async function saveConsent(showNotification = true) {
    const consentData = {
        necessary: true, // v쬯y true
        functional: document.getElementById('consentFunctional').checked,
        analytics: document.getElementById('consentAnalytics').checked,
        marketing: document.getElementById('consentMarketing').checked
    };
    
    try {
        const response = await fetch('/api/auth/consent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(consentData),
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            // Aktualizace cookie consent managementu
            if (window.cookieConsent) {
                window.cookieConsent.updateConsent(consentData);
            }
            
            if (showNotification) {
                showAlert('success', 'Nastaven칤 souhlas콢 bylo 칰sp캩코n캩 ulo쬰no');
            }
        } else {
            throw new Error('Chyba p콏i ukl치d치n칤');
        }
    } catch (error) {
        console.error('Chyba p콏i ukl치d치n칤 souhlas콢:', error);
        if (showNotification) {
            showAlert('danger', 'Chyba p콏i ukl치d치n칤 nastaven칤');
        }
    }
}

async function exportData() {
    console.log('[GDPR] exportData function called');
    const btn = document.getElementById('exportDataBtn');
    
    if (!btn) {
        console.error('[GDPR] Export button not found!');
        showAlert('danger', 'Chyba: tla캜칤tko nenalezeno');
        return;
    }
    
    const originalText = btn.innerHTML;
    console.log('[GDPR] Starting export, button found');
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>P콏ipravuji export...';
        console.log('[GDPR] Button disabled, making fetch request');
        
        const response = await fetch('/api/auth/export-data', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('[GDPR] Fetch response received:', response.status, response.statusText);
        
        if (response.ok) {
            // Sta쬰n칤 souboru
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Z칤sk치n칤 n치zvu souboru z hlavi캜ky
            const contentDisposition = response.headers.get('content-disposition');
            const filename = contentDisposition ? 
                contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                `user-data-${Date.now()}.json`;
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('success', 'Data byla 칰sp캩코n캩 exportov치na');
        } else {
            // P콏e캜ten칤 chybov칠 zpr치vy ze serveru
            const errorData = await response.json().catch(() => ({ message: 'Nezn치m치 chyba' }));
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Chyba p콏i exportu dat:', error);
        showAlert('danger', `Chyba p콏i exportu dat: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function deleteAccount() {
    const form = document.getElementById('deleteAccountForm');
    const password = document.getElementById('confirmPassword').value;
    const confirmed = document.getElementById('confirmDeletion').checked;
    const btn = document.getElementById('confirmDeleteBtn');
    
    if (!password) {
        showAlert('warning', 'Zadejte pros칤m sv칠 heslo');
        return;
    }
    
    if (!confirmed) {
        showAlert('warning', 'Mus칤te potvrdit smaz치n칤 칰캜tu');
        return;
    }
    
    const originalText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ma쬿 칰캜et...';
        
        const response = await fetch('/api/auth/delete-account', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirmPassword: password }),
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // 칔sp캩코n칠 smaz치n칤 - p콏esm캩rov치n칤
            showAlert('success', 'V치코 칰캜et byl 칰sp캩코n캩 smaz치n. P콏esm캩rov치v치m...');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            throw new Error(data.message || 'Chyba p콏i maz치n칤 칰캜tu');
        }
    } catch (error) {
        console.error('Chyba p콏i maz치n칤 칰캜tu:', error);
        showAlert('danger', error.message || 'Chyba p콏i maz치n칤 칰캜tu');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showAlert(type, message) {
    // Vytvo콏en칤 alert elementu
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Automatick칠 odstran캩n칤 po 5 sekund치ch
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>