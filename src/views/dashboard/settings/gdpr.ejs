<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="h4 mb-1">üîí GDPR & Ochrana dat</h2>
          <p class="text-muted mb-0">Spravujte sv√° opr√°vnƒõn√≠ a soukrom√≠</p>
        </div>
        <div class="small text-muted">
          <i class="fas fa-shield-alt me-1"></i> GDPR kompatibiln√≠
        </div>
      </div>
    </div>
  </div>

  <!-- Consent Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-cookie-bite me-2 text-primary"></i>
            Spr√°va souhlas≈Ø s cookies
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">
            Spravujte, kter√© cookies a technologie m≈Ø≈æeme pou≈æ√≠vat pro vylep≈°en√≠ va≈°eho z√°≈æitku.
          </p>
          
          <div id="consentSettings">
            <!-- Nezbytn√© cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-cog me-2 text-secondary"></i>
                    Nezbytn√© cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Tyto cookies jsou nutn√© pro z√°kladn√≠ funkƒçnost webu a nelze je vypnout.
                  </p>
                  <div class="small text-info">
                    <strong>P≈ô√≠klady:</strong> autentizace, CSRF ochrana, relace
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentNecessary" checked disabled>
                  <label class="form-check-label" for="consentNecessary">
                    <span class="badge bg-success">V≈ædy aktivn√≠</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Funkƒçn√≠ cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-tools me-2 text-info"></i>
                    Funkƒçn√≠ cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Vylep≈°uj√≠ funkcionalitu a umo≈æ≈àuj√≠ personalizaci u≈æivatelsk√©ho rozhran√≠.
                  </p>
                  <div class="small text-info">
                    <strong>P≈ô√≠klady:</strong> jazykov√© preference, rozlo≈æen√≠ dashboardu
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentFunctional">
                  <label class="form-check-label" for="consentFunctional"></label>
                </div>
              </div>
            </div>

            <!-- Analytick√© cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-chart-line me-2 text-warning"></i>
                    Analytick√© cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Pom√°haj√≠ n√°m pochopit, jak pou≈æ√≠v√°te web a zlep≈°ovat na≈°e slu≈æby.
                  </p>
                  <div class="small text-info">
                    <strong>P≈ô√≠klady:</strong> Google Analytics, n√°v≈°tƒõvnost str√°nek
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentAnalytics">
                  <label class="form-check-label" for="consentAnalytics"></label>
                </div>
              </div>
            </div>

            <!-- Marketingov√© cookies -->
            <div class="consent-item mb-4">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                  <h6 class="mb-2">
                    <i class="fas fa-bullhorn me-2 text-danger"></i>
                    Marketingov√© cookies
                  </h6>
                  <p class="text-muted small mb-2">
                    Umo≈æ≈àuj√≠ personalizovanou reklamu a marketingovou komunikaci.
                  </p>
                  <div class="small text-info">
                    <strong>P≈ô√≠klady:</strong> c√≠len√° reklama, sledov√°n√≠ kampan√≠
                  </div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="consentMarketing">
                  <label class="form-check-label" for="consentMarketing"></label>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="small text-muted">
              <i class="fas fa-clock me-1"></i>
              Nastaven√≠ se ulo≈æ√≠ automaticky
            </div>
            <button type="button" class="btn btn-primary" id="saveConsentBtn">
              <i class="fas fa-save me-2"></i>Ulo≈æit nastaven√≠
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Rights -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-download me-2 text-success"></i>
            Export dat
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            St√°hnƒõte si v≈°echna va≈°e data ve strukturovan√©m form√°tu podle GDPR ƒçl√°nku 20.
          </p>
          <ul class="list-unstyled small mb-4">
            <li><i class="fas fa-check text-success me-2"></i>Osobn√≠ informace</li>
            <li><i class="fas fa-check text-success me-2"></i>Nastaven√≠ a preference</li>
            <li><i class="fas fa-check text-success me-2"></i>P≈ôipojen√© soci√°ln√≠ s√≠tƒõ</li>
            <li><i class="fas fa-check text-success me-2"></i>Historie souhlas≈Ø</li>
          </ul>
          <button type="button" class="btn btn-success w-100" id="exportDataBtn">
            <i class="fas fa-download me-2"></i>St√°hnout moje data
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card h-100 border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-trash-alt me-2"></i>
            Smaz√°n√≠ √∫ƒçtu
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Trvale sma≈æte v√°≈° √∫ƒçet a v≈°echna souvisej√≠c√≠ data podle GDPR ƒçl√°nku 17.
          </p>
          <div class="alert alert-warning small mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Pozor:</strong> Tato akce je nevratn√° a v≈°echna va≈°e data budou trvale smaz√°na.
          </div>
          <button type="button" class="btn btn-danger w-100" id="deleteAccountBtn" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
            <i class="fas fa-trash-alt me-2"></i>Smazat √∫ƒçet
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Processing Information -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-info-circle me-2 text-info"></i>
            Informace o zpracov√°n√≠ dat
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">Va≈°e pr√°va podle GDPR:</h6>
              <ul class="list-unstyled small">
                <li class="mb-2"><i class="fas fa-eye text-primary me-2"></i><strong>Pr√°vo na p≈ô√≠stup:</strong> Zobrazit zpracov√°van√° data</li>
                <li class="mb-2"><i class="fas fa-edit text-warning me-2"></i><strong>Pr√°vo na opravu:</strong> Upravit nespr√°vn√© √∫daje</li>
                <li class="mb-2"><i class="fas fa-download text-success me-2"></i><strong>Pr√°vo na p≈ôenositelnost:</strong> Export va≈°ich dat</li>
                <li class="mb-2"><i class="fas fa-trash text-danger me-2"></i><strong>Pr√°vo na v√Ωmaz:</strong> Smaz√°n√≠ va≈°ich dat</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Kontakt pro GDPR:</h6>
              <div class="small">
                <p class="mb-1"><strong>Email:</strong> privacy@bekpashop.cz</p>
                <p class="mb-1"><strong>Telefon:</strong> +420 735 791 715</p>
                <p class="mb-1"><strong>Adresa:</strong> Trnava 298, 917 02 Trnava</p>
              </div>
              <div class="mt-3">
                <a href="/legal/privacy" class="btn btn-outline-secondary btn-sm me-2" target="_blank">
                  <i class="fas fa-external-link-alt me-1"></i>Z√°sady ochrany soukrom√≠
                </a>
                <a href="/legal/cookies" class="btn btn-outline-secondary btn-sm" target="_blank">
                  <i class="fas fa-external-link-alt me-1"></i>Cookie Policy
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteAccountModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Potvrzen√≠ smaz√°n√≠ √∫ƒçtu
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <h6 class="alert-heading">
            <i class="fas fa-warning me-2"></i>
            Pozor! Tato akce je nevratn√°
          </h6>
          <p class="mb-0">Smaz√°n√≠m √∫ƒçtu trvale ztrat√≠te:</p>
          <ul class="mt-2 mb-0">
            <li>V≈°echny osobn√≠ √∫daje</li>
            <li>P≈ôipojen√© soci√°ln√≠ s√≠tƒõ</li>
            <li>Napl√°novan√© p≈ô√≠spƒõvky</li>
            <li>Historii aktivit</li>
            <li>Nastaven√≠ a preference</li>
          </ul>
        </div>
        
        <form id="deleteAccountForm">
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Pro potvrzen√≠ zadejte sv√© heslo:</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="Va≈°e aktu√°ln√≠ heslo">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="confirmDeletion" required>
            <label class="form-check-label" for="confirmDeletion">
              Potvrzujem, ≈æe chci trvale smazat sv≈Øj √∫ƒçet a v≈°echna data
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Zru≈°it
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash-alt me-2"></i>Smazat √∫ƒçet
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.consent-item {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 0.5rem;
  background: #f8f9fa;
  transition: all 0.2s ease;
}

.consent-item:hover {
  border-color: #3498db;
  background: #ffffff;
}

.form-check-input:checked {
  background-color: #3498db;
  border-color: #3498db;
}

.card {
  transition: all 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.modal-content {
  border: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.alert-danger {
  border-left: 4px solid #dc3545;
}
</style>

<script>
// Funkce pro inicializaci s opakovan√Ωm pokusem
function initializeGDPR() {
    console.log('[GDPR] Pokus o inicializaci GDPR str√°nky');
    
    // Kontrola existence element≈Ø
    const saveConsentBtn = document.getElementById('saveConsentBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    console.log('[GDPR] Elementy nalezeny:', {
        saveConsentBtn: !!saveConsentBtn,
        exportDataBtn: !!exportDataBtn,
        confirmDeleteBtn: !!confirmDeleteBtn
    });
    
    // Pokud elementy nejsou nalezeny, zkusit znovu
    if (!exportDataBtn || !saveConsentBtn) {
        console.log('[GDPR] Elementy nenalezeny, zkou≈°√≠m znovu za 500ms');
        setTimeout(initializeGDPR, 500);
        return;
    }
    
    // Naƒçten√≠ aktu√°ln√≠ho stavu souhlas≈Ø
    loadCurrentConsent();
    
    // Event listenery s kontrolou existence
    if (saveConsentBtn) {
        saveConsentBtn.addEventListener('click', saveConsent);
        console.log('[GDPR] Event listener pro saveConsent p≈ôid√°n');
    }
    
    if (exportDataBtn) {
        exportDataBtn.addEventListener('click', function(event) {
            console.log('[GDPR] Export button clicked!');
            event.preventDefault();
            exportData();
        });
        console.log('[GDPR] Event listener pro exportData p≈ôid√°n');
    }
    
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', deleteAccount);
        console.log('[GDPR] Event listener pro deleteAccount p≈ôid√°n');
    }
    
    // Auto-save p≈ôi zmƒõnƒõ
    const consentInputs = document.querySelectorAll('#consentSettings input[type="checkbox"]:not([disabled])');
    console.log('[GDPR] Nalezeno', consentInputs.length, 'consent input≈Ø');
    consentInputs.forEach(input => {
        input.addEventListener('change', autoSaveConsent);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('[GDPR] DOMContentLoaded event fired');
    // Mal√° prodleva pro zaji≈°tƒõn√≠, ≈æe jsou v≈°echny elementy v DOM
    setTimeout(initializeGDPR, 100);
});

// Tak√© zkusit inicializaci po naƒçten√≠ okna
window.addEventListener('load', function() {
    console.log('[GDPR] Window load event fired');
    setTimeout(initializeGDPR, 100);
});

function loadCurrentConsent() {
    // Pokud existuje CookieConsent, naƒçteme aktu√°ln√≠ stav
    if (window.cookieConsent) {
        const consent = window.cookieConsent.getCurrentConsent();
        if (consent) {
            document.getElementById('consentFunctional').checked = consent.functional || false;
            document.getElementById('consentAnalytics').checked = consent.analytics || false;
            document.getElementById('consentMarketing').checked = consent.marketing || false;
        }
    }
}

async function autoSaveConsent() {
    await saveConsent(false); // false = tich√Ω re≈æim bez notifikace
}

async function saveConsent(showNotification = true) {
    const consentData = {
        necessary: true, // v≈ædy true
        functional: document.getElementById('consentFunctional').checked,
        analytics: document.getElementById('consentAnalytics').checked,
        marketing: document.getElementById('consentMarketing').checked
    };
    
    try {
        const response = await fetch('/api/auth/consent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(consentData),
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            // Aktualizace cookie consent managementu
            if (window.cookieConsent) {
                window.cookieConsent.updateConsent(consentData);
            }
            
            if (showNotification) {
                showAlert('success', 'Nastaven√≠ souhlas≈Ø bylo √∫spƒõ≈°nƒõ ulo≈æeno');
            }
        } else {
            throw new Error('Chyba p≈ôi ukl√°d√°n√≠');
        }
    } catch (error) {
        console.error('Chyba p≈ôi ukl√°d√°n√≠ souhlas≈Ø:', error);
        if (showNotification) {
            showAlert('danger', 'Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠');
        }
    }
}

async function exportData() {
    console.log('[GDPR] exportData function called');
    const btn = document.getElementById('exportDataBtn');
    
    if (!btn) {
        console.error('[GDPR] Export button not found!');
        showAlert('danger', 'Chyba: tlaƒç√≠tko nenalezeno');
        return;
    }
    
    const originalText = btn.innerHTML;
    console.log('[GDPR] Starting export, button found');
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>P≈ôipravuji export...';
        console.log('[GDPR] Button disabled, making fetch request');
        
        const response = await fetch('/api/auth/export-data', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('[GDPR] Fetch response received:', response.status, response.statusText);
        
        if (response.ok) {
            // Sta≈æen√≠ souboru
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Z√≠sk√°n√≠ n√°zvu souboru z hlaviƒçky
            const contentDisposition = response.headers.get('content-disposition');
            const filename = contentDisposition ? 
                contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                `user-data-${Date.now()}.json`;
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('success', 'Data byla √∫spƒõ≈°nƒõ exportov√°na');
        } else {
            // P≈ôeƒçten√≠ chybov√© zpr√°vy ze serveru
            const errorData = await response.json().catch(() => ({ message: 'Nezn√°m√° chyba' }));
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Chyba p≈ôi exportu dat:', error);
        showAlert('danger', `Chyba p≈ôi exportu dat: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function deleteAccount() {
    const form = document.getElementById('deleteAccountForm');
    const password = document.getElementById('confirmPassword').value;
    const confirmed = document.getElementById('confirmDeletion').checked;
    const btn = document.getElementById('confirmDeleteBtn');
    
    if (!password) {
        showAlert('warning', 'Zadejte pros√≠m sv√© heslo');
        return;
    }
    
    if (!confirmed) {
        showAlert('warning', 'Mus√≠te potvrdit smaz√°n√≠ √∫ƒçtu');
        return;
    }
    
    const originalText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ma≈æu √∫ƒçet...';
        
        const response = await fetch('/api/auth/delete-account', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ confirmPassword: password }),
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // √öspƒõ≈°n√© smaz√°n√≠ - p≈ôesmƒõrov√°n√≠
            showAlert('success', 'V√°≈° √∫ƒçet byl √∫spƒõ≈°nƒõ smaz√°n. P≈ôesmƒõrov√°v√°m...');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            throw new Error(data.message || 'Chyba p≈ôi maz√°n√≠ √∫ƒçtu');
        }
    } catch (error) {
        console.error('Chyba p≈ôi maz√°n√≠ √∫ƒçtu:', error);
        showAlert('danger', error.message || 'Chyba p≈ôi maz√°n√≠ √∫ƒçtu');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showAlert(type, message) {
    // Vytvo≈ôen√≠ alert elementu
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Automatick√© odstranƒõn√≠ po 5 sekund√°ch
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>